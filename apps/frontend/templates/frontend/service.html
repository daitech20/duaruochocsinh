{% extends 'base.html' %}
{% load static %}
{% block cart %}
<section>
  <div class="row">
    <div class="col-3">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Tìm đường đi</h5>
          <div style="padding-bottom: 10px;">
            <label>Điểm bắt đầu</label>
              <select id="html_select_starting_point" style="width: 100%;">
                <option></option>
              </select>
          </div>
          <div>
            <label>Điểm kết thúc</label>
              <select id="html_select_ending_point" style="width: 100%;">
                <option></option>
              </select>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Tuyến đường đi</h5>
          <div id="html_select_list_router">
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Trạm</h5>
          <div id="html_list_detail_router">

          </div>
        </div>
      </div>
    </div>
    <div class="col-7">
      <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3918.51036180692!2d106.78445327336814!3d10.848733189304461!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752713471f5b15%3A0x1d5dddea640dad31!2zOTcgxJAuIE1hbiBUaGnhu4duLCBIaeG7h3AgUGjDuiwgUXXhuq1uIDksIFRow6BuaCBwaOG7kSBI4buTIENow60gTWluaCwgVmnhu4d0IE5hbQ!5e0!3m2!1svi!2s!4v1714053135713!5m2!1svi!2s"
        width="100%" height="100%" frameborder="0" style="border:0" allowfullscreen>
      </iframe>
    </div>
    <div class="col-2">
      <div>
        <label class="mb-2">Loại xe</label>
        <select class="form-select border border-secondary" style="height: 35px;">
          <option>16 chỗ</option>
          <option>29 chỗ</option>
          <option>45 chỗ</option>
        </select>
      </div>
        </p>
      <div>
        <label class="mb-2">Thời gian</label>
        <select class="form-select border border-secondary" style="height: 35px;">
          <option>3 tháng</option>
          <option>6 tháng</option>
          <option>9 tháng</option>
        </select>
      </div>
        </p>
      <div>
        <label class="mb-2">Thời gian đón</label>
        <select class="form-select border border-secondary" style="height: 35px;">
          <option>7:00</option>
          <option>13:00</option>
        </select>
      </div>
        </p>
      <div>
        <label class="mb-2 d-block">Quantity</label>
        <div class="input-group mb-3" style="width: 170px;">
            <button class="btn btn-white border border-secondary px-3" type="button" id="decreaseBtn" data-mdb-ripple-color="dark">
                <i class="fas fa-minus"></i>
            </button>
            <input type="text" id="quantityInput" class="form-control text-center border border-secondary" value="1" aria-label="Example text with button addon" aria-describedby="button-addon1" />
            <button class="btn btn-white border border-secondary px-3" type="button" id="increaseBtn" data-mdb-ripple-color="dark">
                <i class="fas fa-plus"></i>
            </button>
        </div>
      </div>

      <script>
        // Lấy ra các phần tử cần thiết
        const decreaseBtn = document.getElementById('decreaseBtn');
        const increaseBtn = document.getElementById('increaseBtn');
        const quantityInput = document.getElementById('quantityInput');

        // Xử lý sự kiện khi nhấn nút giảm
        decreaseBtn.addEventListener('click', function() {
            let currentValue = parseInt(quantityInput.value);
            if (!isNaN(currentValue) && currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        });

        // Xử lý sự kiện khi nhấn nút tăng
        increaseBtn.addEventListener('click', function() {
            let currentValue = parseInt(quantityInput.value);
            if (!isNaN(currentValue)) {
                quantityInput.value = currentValue + 1;
            }
        });
      </script>
      <hr />

      <div>
        <span class="h5">$75.00</span>
      </div>
        </p>
      <div>
        <a href="{% url 'frontend:checkout'%}" class="btn btn-warning shadow-0"> Buy now </a>
        <a class="btn btn-primary shadow-0"> <i class="sm-1 fa fa-shopping-basket"></i></a>
      </div>
    </div>
  </div>
</section>
<script>
  let origin_url = window.location.origin;
  let list_starting_point=[];
  let list_ending_point=[];
  let list_router=[];
  let pickup;
  let detail_router;
  let sort_stop_station=[];
  let html_select_starting_point = document.getElementById('html_select_starting_point');
  let html_select_ending_point = document.getElementById('html_select_ending_point');
  let html_select_list_router = document.getElementById('html_select_list_router');
  let html_list_detail_router = document.getElementById('html_list_detail_router');

  //event load data starting point
  load_data_starting_point();
  // event load data ending point
  load_data_router();
  // event select starting point
  html_select_starting_point.addEventListener('change', function() {
    display_ending_point(html_select_starting_point.value);
    pickup=html_select_starting_point.value;
  });
   // event select ending point
   html_select_ending_point.addEventListener('change', function() {
    display_router(html_select_ending_point.value);
  });

  async function display_stop_station(id){
    html_list_detail_router.innerHTML = ``;
    detail_router=await fetch_detail_stop_station(id);
        const div = document.createElement('div');
        var list_detail_chirden_station = '';
        sort_stop_station=detail_router.route_detail;
        sort_stop_station.sort((a, b) => a.sequence - b.sequence);
        sort_stop_station.forEach(function (item) {
          list_detail_chirden_station += `
            <div style="padding: 5px; border-bottom: 1px solid;">
              <span>${item?.station?.name}</span>
            </div>
          `;
        });
        div.innerHTML = `
            <div style="padding: 5px; border-bottom: 1px solid;">
              <span>${detail_router?.pickup?.name}</span>
            </div>
            <div>
              ${list_detail_chirden_station}
            <div>
            <div style="padding: 5px; border-bottom: 1px solid;">
              <span>${detail_router?.dropoff?.name}</span>
            </div>
         `;
    html_list_detail_router.appendChild(div);

  
    var pickup=detail_router?.pickup;
    var dropoff=detail_router?.dropoff;

    const url_map = 'https://www.google.com/maps/dir/';
    let url = `${url_map}${pickup.latitude},${pickup.longitude}`;
    sort_stop_station.forEach(item => {
        url += `/${item?.station?.latitude},${item?.station?.longitude}`;
    });
    url += `/${dropoff.latitude},${dropoff.longitude}`;
    
    window.open(`${url}`, '_blank', 'width=800,height=600');
  }
  async function fetch_detail_stop_station(id) {
    return fetch(`${origin_url}/service/api/v1/get-route/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.data) {return data.data;}
            throw new Error('No data found');
        })
        .catch(error => {
            console.error(error);
            throw error;
        });
  }

  function display_router(dropoff){
    html_select_list_router.innerHTML = ``;
    html_list_detail_router.innerHTML = ``;
    const list_router_dislay= list_router.filter(item => item.pickup == pickup&&item.dropoff == dropoff);
    list_router_dislay.forEach(function (item) {
        const div = document.createElement('div');
        div.innerHTML = `
          <div style="padding: 5px; border-bottom: 1px solid;">
            <span>${item.name}</span>
          </div>
         `;
         div.addEventListener('click', function () {
            display_stop_station(item.id);

         });
         html_select_list_router.appendChild(div);
        })
  }

  async function display_ending_point(id){
    const list_id_ending_point = list_router.filter(item => item.pickup == id);
    html_select_ending_point.innerHTML=`<option></option>`;
    html_select_list_router.innerHTML = ``;
    html_list_detail_router.innerHTML = ``;
    if(list_id_ending_point.length!==0){
      list_ending_point=[];
      for(const item of list_id_ending_point){
        let data= await fetch_detail_ending_point(item.dropoff);
        list_ending_point.push(data);
      }
      list_ending_point.forEach(function (item) {
          const opi = document.createElement('option');
          opi.value = item.id;
          opi.text = item.name;
          html_select_ending_point.appendChild(opi);
        })
    }
  }
  async function fetch_detail_ending_point(id) {
    return fetch(`${origin_url}/service/api/v1/get-station/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.data) {return data.data;}
            throw new Error('No data found');
        })
        .catch(error => {
            console.error(error);
            throw error;
        });
  }
  
  function load_data_starting_point(){
    fetch_data_starting_point();
    function fetch_data_starting_point(id) {
      return fetch(`${origin_url}/service/api/v1/list-station`)
          .then(response => response.json())
          .then(data => {
              if(data.data){display_starting_point(data);}
              throw new Error('No data found');
          })
          .catch(error => {
              console.error(error);
              throw error;
          });
    }
    function display_starting_point(data){
      if(data.data){
        list_starting_point=data.data;
        list_starting_point.forEach(function (item) {
          const opi = document.createElement('option');
          opi.value = item.id;
          opi.text = item.name;
          html_select_starting_point.appendChild(opi);
        })
      }
    }
  }
  
  function load_data_router(){
    fetch_data_router();
    function fetch_data_router(id) {
      return fetch(`${origin_url}/service/api/v1/list-route`)
          .then(response => response.json())
          .then(data => {
              if(data.data){ list_router=data.data;}
              throw new Error('No data found');
          })
          .catch(error => {
              console.error(error);
              throw error;
          });
    }
  }
</script>
{% endblock cart %}
